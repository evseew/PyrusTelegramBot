# Excel отчет по преподавателям из Pyrus

Скрипт `pyrus_excel_report.py` создает детальный Excel отчет с анализом эффективности преподавателей на основе данных из двух форм Pyrus.

## Что делает скрипт

### Анализируемые формы:

**Форма 2304918 (возврат студентов с прошлого года):**
- Извлекает ФИО преподавателя из поля 8
- Считает общее количество форм у преподавателя  
- Считает формы с отметкой "учится" в поле 64
- Вычисляет процент возврата: (студентов с отметкой "учится" / общее количество) * 100

**Форма 792300 (конверсия trial → студент):**
- Извлекает ФИО преподавателя из поля 142
- Считает общее количество форм у преподавателя
- Считает формы с отметкой "учится" в поле 187  
- Вычисляет процент конверсии: (студентов с отметкой "учится" / общее количество) * 100

### Итоговый результат:
- Группирует данные по преподавателям
- Суммирует оба процента для каждого преподавателя
- Создает Excel файл с тремя листами

## Структура Excel отчета

### 1. Лист "Сводка по преподавателям"
Основной отчет с колонками:
- ФИО преподавателя
- 2304918: Всего форм 
- 2304918: Учится
- 2304918: % возврата
- 792300: Всего форм
- 792300: Учится  
- 792300: % конверсии
- **Итоговый %** (сумма двух процентов)

### 2. Лист "Детализация по формам"
Разбивка по формам для каждого преподавателя:
- ФИО преподавателя
- Форма (2304918 или 792300)
- Всего задач
- Задач с отметкой 'учится'
- Процент

### 3. Лист "Исходные данные"
Детальные данные для проверки расчетов:
- ID задачи
- Форма
- Преподаватель
- Учится (галочка)

## Установка зависимостей

```bash
pip install -r requirements.txt
```

Новые зависимости:
- `openpyxl==3.1.2` - для работы с Excel файлами
- `pandas==2.1.4` - для анализа данных

## Настройка окружения

Убедитесь, что в файле `.env` настроены:

```env
PYRUS_LOGIN=your_login
PYRUS_SECURITY_KEY=your_security_key
PYRUS_API_URL=https://api.pyrus.com/v4/
```

## Запуск скрипта

```bash
python pyrus_excel_report.py
```

### Что происходит при запуске:

1. **Проверка окружения** - скрипт проверит наличие необходимых переменных
2. **Подключение к Pyrus** - авторизация через API
3. **Анализ формы 2304918** - обработка всех активных задач
4. **Анализ формы 792300** - обработка всех активных задач  
5. **Создание Excel файла** - генерация отчета с временной меткой
6. **Вывод статистики** - краткий обзор результатов в консоли

### Пример вывода:

```
Начинаем анализ данных из Pyrus...
Время начала: 2025-09-15 14:30:00

Анализ формы 2304918 (возврат студентов)...
Обработано 100 задач формы 2304918...
Завершен анализ формы 2304918. Обработано 247 задач.

Анализ формы 792300 (конверсия trial)...
Обработано 100 задач формы 792300...
Завершен анализ формы 792300. Обработано 183 задач.

=== КРАТКАЯ СТАТИСТИКА ===
Всего преподавателей: 15

Топ-5 преподавателей по итоговому проценту:
1. Иванова А.С.: 87.50% (возврат: 45.00%, конверсия: 42.50%)
2. Петров В.И.: 82.30% (возврат: 38.20%, конверсия: 44.10%)
...

Создание Excel отчета: pyrus_teacher_report_20250915_143045.xlsx
Отчет сохранен: pyrus_teacher_report_20250915_143045.xlsx

Анализ завершен: 2025-09-15 14:30:45
```

## Выходной файл

Скрипт создает файл с именем: `pyrus_teacher_report_YYYYMMDD_HHMMSS.xlsx`

Пример: `pyrus_teacher_report_20250915_143045.xlsx`

## Особенности работы

### Обработка данных преподавателей:
- Поддерживает разные форматы полей сотрудников (first_name/last_name, text, name)
- Обрабатывает случаи отсутствующих данных
- Группирует по полному ФИО

### Обработка отметок "учится":
- Поддерживает булевы значения (true/false)
- Обрабатывает чекбоксы (checked/unchecked)  
- Распознает текстовые значения ("да", "yes", "true")

### Производительность:
- Показывает прогресс обработки каждые 100 задач
- Использует асинхронные запросы к API
- Обрабатывает только активные (не архивные) задачи

## Устранение неполадок

### Ошибка: "Не установлены переменные окружения"
Проверьте файл `.env` и убедитесь, что PYRUS_LOGIN и PYRUS_SECURITY_KEY заданы корректно.

### Ошибка подключения к API
Проверьте:
- Правильность логина и ключа безопасности
- Доступность API Pyrus
- Интернет-соединение

### Пустой отчет
Возможные причины:
- Нет активных задач в указанных формах
- Неправильные ID полей (в коде используются фиксированные ID)
- Все задачи находятся в архиве

## Техническая информация

### Используемые ID полей:

**Форма 2304918:**
- Поле 8: Преподаватель (ФИО)
- Поле 64: УЧИТСЯ (заполняет СО) - галочка

**Форма 792300:**  
- Поле 142: Преподаватель (ФИО)
- Поле 187: Учится - галочка

### Архитектура скрипта:
- `PyrusDataAnalyzer` - основной класс анализатора
- `TeacherStats` - класс для хранения статистики по преподавателю
- Использует существующий `PyrusClient` из проекта
- Многоуровневая структура Excel с форматированием

## Расширение функциональности

Для добавления новых форм или полей:

1. Добавьте новые методы анализа в `PyrusDataAnalyzer`
2. Расширьте класс `TeacherStats` для новых метрик
3. Обновите методы создания Excel листов
4. Добавьте соответствующие константы ID полей

Для изменения логики подсчета процентов измените свойства `return_percentage`, `conversion_percentage` и `total_percentage` в классе `TeacherStats`.
