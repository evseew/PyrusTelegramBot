# Отчет по проблемным формам для руководителей

## Описание

Скрипт `managers_problems_report.py` создает Excel отчет по проблемным задачам форм 2304918 и 792300, сгруппированный по зонам ответственности руководителей.

## Группировка по руководителям

- **Галина Александровна**: ЧТЗ, Копейск, Славы, Чурилово
- **Валерия Владимировна**: ЧМЗ, Парковый, Центр, Онлайн  
- **Екатерина Евгеньевна**: Чичерина, Ленинский, Макеева, Академ, Кашириных

## Структура отчета

### Вкладки Excel файла:
1. **Отдельная вкладка для каждого руководителя** с проблемными задачами в их зоне ответственности
2. **Сводная вкладка** с общей статистикой по всем руководителям

### Данные в отчете:
- Форма (2304918 или 792300)
- ФИО студента (поле 2 для формы 2304918, поле 73 для формы 792300)
- ФИО преподавателя
- Статус регистрации (✅ зарегистрирован / ❌ не зарегистрирован)
- Краткое описание проблем
- Ссылка на задачу в Pyrus

### Структура группировки:
1. **По руководителям** (отдельные вкладки Excel)
2. **По филиалам** (разделы с зелеными заголовками)
3. **По преподавателям** (задачи одного преподавателя идут подряд)
4. **По задачам** (отсортированы по ID внутри группы преподавателя)

**Примечание**: 
- Колонка "Филиал" убрана - есть заголовки разделов
- Заголовки преподавателей убраны - ФИО уже в колонке
- Все задачи одного преподавателя в филиале сгруппированы вместе

### Статистика по группам:
- Общее количество проблемных задач
- Количество уникальных преподавателей
- Количество зарегистрированных преподавателей
- Количество незарегистрированных преподавателей
- Количество филиалов

## Запуск

```bash
cd /path/to/PyrusTelegramBot
python3 managers_problems_report.py
```

## Требования

1. Настроенные переменные окружения в `.env`:
   - `PYRUS_LOGIN` и `PYRUS_SECURITY_KEY` для доступа к Pyrus API
   - `SUPABASE_URL` и `SUPABASE_KEY` для доступа к базе пользователей
   - `TZ` для корректного определения временной зоны

2. Установленные зависимости:
   - `pandas`
   - `openpyxl`
   - `python-dotenv`
   - `pytz`

## Результат

Создается файл `reports/managers_problems_report_YYYYMMDD_HHMMSS.xlsx` с детальным анализом проблемных форм по каждому руководителю.

## Логика работы

1. **Анализ проблемных задач**: Использует существующие правила проверки из `app/rules/form_2304918.py` и `app/rules/form_792300.py`
2. **Определение филиала**: Извлекает данные из полей 5 (форма 2304918) и 226 (форма 792300)
3. **Проверка регистрации**: Сопоставляет преподавателей с базой зарегистрированных пользователей
4. **Группировка**: Распределяет задачи по руководителям на основе принадлежности филиала

## Временной диапазон

Анализирует проблемы за вчерашний день (target_day = вчера) согласно логике существующих проверок форм.
